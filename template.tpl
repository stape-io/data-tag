___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Data Tag",
  "categories": [
    "ANALYTICS",
    "CONVERSIONS"
  ],
  "brand": {
    "id": "github.com_stape-io",
    "displayName": "stape-io",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABjkSURBVHgB7d1dclRXmi7gbymTEyei+kJnBK0aQcmBOFF3FiM4eATAbR8MYgSIEVgUct1aHgHUCFDdVXSJsGoEzh5B66I6oiOszNX5Q7txmR/tzJ2Za+39PBeAfUmIzHd/63vXTsHa5aODw5jEl5FjP1Lej5x2p/97NwBYSHE5/Yy8mv7+59iJ83RycR6sVQrWIh8d7sbk70+mP9BH4cseoKE0ipicx+DW83Tyl1HQOgGgZb74AVq2EyeRhi8EgXYJAC1ajPrTd5HzXgDQoulEIOeH6dTRQFt2glbkxwfPYhxvfPkDrMP0szXFm/lnLa0wAWjB/Acyx3EAsH4pjtMfLp4HKxEAVuTLH2ALhICVCQAryI/+771Ik1cBwObluGsnYHkCwJLy0e/3YjJ25g+wPVcxuP5tOrm8ChqzBLis65+OffkDbNVujAffBEsxAVjC/Ol/fP1jALB9jgKWYgKwjNnTPwBl2Mn3gsZMABrKR/vTkdPw3wOAUtgFWIIJQFPjW5ImQFl2fTY3JwA0lSeHAUBpvgwaEQCa2km/CwBKcxg0IgA0lWM/ACiMWnZTAkAD8/ofAEXyGd2MAAAAPSQAAEAPCQAA0EMCAAD0kAAAAD0kAABADwkAANBDAgAA9JAAAAA9JAAAQA8JAADQQwIAAPSQAABAJ6STv4yCGxMAAKhfisugEQEAgPrl+LegEQEAgA5Ir4NGBAAA6jcYnAeNCAAA1O5PFgCbEwAAqFuOk6AxAQCAmp2n04vzoDEBAIB6DYYPg6UIAABUKp85+1/eMACgOmk0ffp/HixNAACgPpP8Ir309L8KRwAAVCaN0rcXNv9XJAAAUBuj/xY4AgCgIvksvbw4C1ZmAgBAPQa3PP23RAAAoA45v1D7a48jAAAqkEYxHFr8a5EJAAA1eO7pv10CAACFS6P08q9nQasEAADKNo6vgtbZAQCgYPks/fHiMmidCQAA5VL7WxsBAIAyZYt/6yQAAFCgNEqnF8fB2ggAAJTI6H/NBAAACqP2twkCAABlGQzuBmsnAABQkHxm8W8zBAAASnGl9rc5AgAAZcjhbX8bJAAAUAC1v00TAAAogdH/hgkAAGzba7W/zRMAANiuwfBpsHECAABbpPa3LV4HDMCWpNH06d/Z/5aYAACwLd72t0UCAABb4L7/bRMAANi8PLH4t2UCAAAbls/S6dvXwVYJAABslvv+iyAAALA52eJfKdQAAdiQNIrh4CwoggkAAJvi6b8gAgAAG6D2VxoBAID1G8dXQVHsAACwZvks/fHiMiiKCQAA66X2VyQBAID1UfsrlgAAwJqkUTq9OA6KJAAAsC5G/wUTAABoX4pLtb+yCQAAtG9nqPZXOAEAgJblM4t/5XMPAAAtSqMYDJ39V8AEAID25Py9p/86CAAAtETtryYCAABtMfqviAAAQBteq/3VRQAAYHWD4dOgKgIAACtS+6uRGiAAK1D7q5UJAACr8La/SgkAACwpjSz+1UsAAGA5eWLxr2ICAABLyGfp9O3roFoCAADNDW5Z/KucAABAM9niXxeoAQLQQBrF8DcnQfVMAABoYvr0f34VVE8AAOCG1P66RAAA4GYGg7tBZwgAANyA+/67RgAA4PPU/jpHAADg09T+OkkAAOAT0iidXhwHnSMAAPApRv8dJQAA8DHnan/dJQAA8GGD4cOgswQAAD5A7a/rvAsAgH+QRtOnf2f/HScAAPBLk/wivfT033WOAAB4Txqlby+87a8HBAAA3mf03xOOAAB4J5+llxdnQS+YAACw4L7/XhEAAJg+/OcXan/94ggAoPfSKIZDi389YwIAgLf99ZAAANBraeS+/34SAAD6LGf3/feUHQCA3spn6fTtedBLJgAAfaX212sCAEAfZYt/fecIAKB3ZrW/36j99ZwJAED/TJ/+z6+CXhMAAHpF7Y8FAQCgTwaDuwEhAAD0SD6z+Md/EwAA+uFK7Y/3CQAAfZDD2/74BQEAoPPSKJ1eHAe8RwAA6D6jf35FAADotnO1Pz5EAADossHQ2/74IAEAoLPU/vg47wIA6KQ0mj79O/vnowQAgC6a5Bfppad/Ps4RAEDnpFH69sLb/vgkAQCge4z++SxHAACdks/Sy4uzgM8wAQDoEvf9c0MCAEBX5Oy+f27MEQBAJ6RRDIcW/7gxEwCAbnju6Z8mBACA6qWR+/5pSgAAqN04vgpoyA4AQNXyWfrjxWVAQyYAADVT+2NJAgBArbLFP5YnAABUKY3S6cVxwJIEAIA6Gf2zEgEAoDYpLtX+WJUAAFCbnaHaHysTAACqks8s/tEG9wAAVCONYjB09k8rTAAAapHz957+aYsAAFAFtT/aJQAA1MHon1YJAADle632R9sEAIDSDYZPA1omAAAUTe2P9VADBCiW2h/rYwIAUC5v+2NtBACAIqWRxT/WSQAAKFGeWPxjrQQAgOLks3T69nXAGgkAAKUZ3LL4x9oJAAAlyRb/2Aw1QIBipFEMB2cBG2ACAFAOT/9sjAAAUAS1PzZLAAAowTi+CtggOwAAW5fP0h8vLgM2yAQAYNvU/tgCAaCR/7wKgDap/bElKWgkP779Y+S0FwArmy/+/TZgC0wAmsrpbwHQDqN/tkYAaO48AFaV4lLtj20SAJoaDL2gA1jdzlDtj60SABp6t6xzHgBLy2cW/9g2AWAZ2bkdsKw0UvujBALAEtLpxXmYAgDLmOQXnv4pgQCwLFMAoLE0St9enAQUQABY0nwKkPOLALg5Dw4Uw0VAK8pfH7yZ/nYYAJ+Uz9LLtw8DCmECsKrB9VeR0igAPsXiH4URAFaUTi6vYmdwd3apRwB8kNof5XEE0KL86PbJdBrwJAB+Nqv9De4KAJTGBKBF6fTt0fTXh44EgPd42x9FMgFYk/zo4Hj6tzubBuwG0FPe9ke5TADWJJ1eHMdg+EXk/H0A/ZQnTwMKZQKwAfno93sxGb+ZhoG9AHpC7Y+yCQAblL++82D6N/5MEIAeGAx/6+yfkjkC2KD5u793fvrCNcLQcdniH+UzAdiS+bHA9U/HkdL9ADpkVvv7zRfp5PwqoGACwJblRweHsZO+cywAXZEezqd9UDgBoBD2A6AL1P6ohx2AQiz2AwZ3vWEQKjaY/huGSpgAFMh+ANRI7Y+6CAAFcywA1biaXfxl85+aCAAVyP//4CgG6YkgAIWa1f5mt39CRQSASjgWgFJZ/KNOlgArMRstptO3D2a3i01j22UApXCxF1UyAaiU/QAownl6eWHznyoJAJV799rhZwFsnvv+qZgjgMq9e+3wb712GDYtn/nyp2YmAB2S/+XOfgzjlWMBWLfZff+DuwIANRMAOsh+AKzZJJ6mby9OAiomAHTUojZ4/cB+ALRN7Y9usAPQUYvaoP0AWAO1PzrBBKAn8qPb92Jn5xvHArAK9/3THQJAz9gPgBWo/dEhjgB65r3XDjsWgCZyfuHLny4xAeix+aLg+Hq2yfz/AvgEtT+6RwDAsQB8Vno4n55BhwgA/Gx+rfBOui8IwPvU/ugmOwD8bF4btB8Av5SzrX86yQSAD5rvB0yuX0WO/YDeUvujuwQAPsl+AL2m9keHCQDciNcO0zs5ns+PxaCj7ABwI64Vpl/SKIb/5GU/dJoJAI157TDdp/ZH9wkALM1+AN2k9kc/OAJgae9dK/wioCsG059p6AETAFoxrw1e/3QcKd0PqJbaH/0hANAqxwJU7CoGwy/U/ugLAYC1EASojtofPSMAsDaOBaiHxT/6xxIgazMbpabTtw/m9wdE/CmgXM8DesYEgI1xLEChztPLC5v/9I4AwMa9u1b4yfSPuwHbluPu9Oz/PKBnBAC2wn4AhfD0T2/ZAWArfrEfkNIoYCuSd1vQWyYAFMF+AJtn859+MwGgCItrhX/6YtbFDtiIyXlAj5kAUBz7AWzEIH2RTv56GdBTAgDFcizA+hj/gyMAivXz2wZTeEqjZcb/IABQtHlb4A8XdgNoV3YzJQgAVGH+khYhgLYMb5kq0Xt2AKjKfC8g8ncBy7tKLy/+T0DPmQBQlfleQKSHAcvz9A8hAFAhIYCVpPy3AAQA6jQPAXYCWEq6CkAAoF7zxcCI1wFNZO+egBkBgLoNrh96mRCN5IkJAIQAQOXSyeVVTLJ9ABpwBAAzAgDVmx4FnEfOLwKAGxMA6Ibh+Hj6qyc7biDvBiAA0A3zo4BITwM+J+0IABACAB0yrwZaCAS4EQGAbnE3AJ+TvF4aZgQAOmVxS6BdAD4hp38OQACgg1JoBPBxKe8HIADQQTvXJwEfk2MvAAGA7lk0AuI84MN289Hv9wJ6TgCgq/4U8DHj63sBPScA0E2D67OAj0q/C+g5AYBOmh8DpLgM+KBsAkDvCQB0WP5zwIft5kcHhwE9JgDQXTmbAPBxKd0P6DEBgO4a/K/zgI/K9/LRvvcC0FsCAB32n24E5FN2YzI8CugpAYDOWiwC5lHAx2THAPSXAEDHJVMAPiHv5a/vPAjoIQGAbsvxbwGf9swuAH0kANBtOZsA8Bl5zy4AfSQAAOR44v0A9I0AADBrBIyvvwvoEQEAYOEwf33gKIDeEADotpT+OeDmnuV/ubMf0AMCAMD/2I1BvNIKoA8EALrO0xwNzVsBb4QAuk4AoLPefYD7EKe5PA2O48E3AR0mANBhQ0//rCA9yF/f1gygswQAumuc9gJWMgsBB3YC6CQBgO7Kk8OA1d2L8a0fXBRE1wgAdNfOzpcBrch7MR6/yY8ODgM6QgCgk+ZPa3n6oQ2tmf48pXiTHx88C+gAAYBuGo8PA9Yhx3H++s6PjgSonQBAR+X7AWszOxK4/nHWEhAEqFUK6Jj5B/L0wzlgM66mn6Qn6Q8XzwMqYgJA91z/dBywObs/Hwt8fedBQCVMAOiU+dP/ZPzGAiBbdB6D4cN08pdRQMFMAOiW2fKfL3+269B+ADUwAaAzPP1TnjSa/mS+SC8vTgIKYwJAd0yu7/vypyzzn8dv7AdQIhMAOsHmP3XIZzG49dx+ACUwAaAbbP5ThfRgvh/w5OAb+wFsmwkA1ctHB4cxjjcBVZntB8Tz9PKvZwFbIABQvfz4zo/O/qnXNAgM8sN0cnEesEECAFVbLFbl7wKqZz+AzRIAqJbaH52U4ti1wmyCJUDqla+f+PKnc1wrzIaYAFAltT/6YbYfMLjrWIB1MAGgTmp/9ILXDrM+JgBUx+IfPeW1w7RKAKA6an/0m/sDaIcAQFWmX/6zxT8vVoGI1zEYPrUfwLIEAKqh9gcf4v4AlmMJkHrMFv98+cM/mL1fYPxGbZCmTACogtof3EQaRZ48TadvXwd8hgkAdRhf2/qHz5pOyFJ6pTbITZgAUDy1P1hSiuPYGX5vP4APMQGgfCmeBdBcngYA+wF8hAkARcuPD57NP8SAFc2uFY6v0slfLwNCAKBg7xb/fpj+cTeAlqgNsuAIgHIt7vv35Q+tmtUGr3+cT9foNRMAiqT2B5vgWuE+EwAokvv+YYNSXMbO8CvHAv0iAFActT/YFvsBfSIAUJR8dLgbk//4wdM/bMv0WCDlM68d7j5LgJRl8vcnvvxhm6b//nIcTydxP7o/oNtMACiGxT8oktcOd5QJAOVY1P6Astyb1wa9X6BzTAAoQj66Pf2QSa8CKJjaYJcIABRB7Q9q4rXDXSAAsHVqf1ArtcGaCQBs1fxMcTJ+4+kfKua1w1WyBMh2zRb/fPlD3bx2uEomAGyN2h900ey1w4O7pgHlMwFge9T+oIPyntpgHUwA2AqLf9ATKY5dK1wmAYCtUPuDPnF/QIkEADYuPz54Nl8aAvrFa4eLIgCwUWp/gPsDymAJkM1S+wMiPVjUBg+Ogq0xAWBj1P6AX7MfsC0mAGzO5NrLfoB/MJsI5u/UBjfPBICNUPsDbmQnTiINX9gPWD8TADYjxbMA+JxJHLlWeDNMAFg7tT9gObNrhfPDdHJxHrROAGCtLP4Bq1MbXAdHAKyX+/6Blc1qg9c/qA22ywSAtclHd/ZjnH8IgLZ4t0BrTABYn0mo/QHtynE8qwwGKxMAWIv5Bq8b/4C1SA/yk4NvgpU4AqB17vsHNuRpenlxEizFBID2Ta7v+/IHNuCZ2wOXJwDQqvk/Rp1/YDN2Y3xtH2BJAgDtUvsDNuswPzo4DBoTAGhNPrp9L1K6HwCb5KrxpQgAtGeyYysX2IbDfLS/GzQiANAKtT9gq8a37gWNCACsbL74ZwQHbNeXQSMCAKubLf55+ge26zBoRABgJYunf4t/wLZ5CGlKAGA142uLf0ARXArUjADA0uaLfxEWbwAqJACwPIt/ANUSAFhKfnzwzOIfQL0EABpbnLOlBwFAtQQAmlP7A6ieAEAjan8A3SAA0Mzk+lUAUD0BgBtb3Pcf+wFA9QQAbk7tD6AzBABuRO0PoFsEAD5rvviX4zgA6AwBgM+b1f4A6BQBgE/KR3f21f4AukcA4NMmofYH0EECAB+1qP1Z/APoIgGAD1rc+Kf2B9BVw4APyddPIsdeANBJJgD8yvzpfxJHAUBnCQD8mtofQOc5AuAX5ot/kdX+ADrOBIBfsvgH0AsCAD/Lj+88UfsD6AcBgLn54l9Y/APoCwGAhdnin6d/gN4QAHh36Y/7/gH6RAAgYnz9XQDQKwJAzy1qf3EYAPSKANB3an8AvSQA9Fh+fPDM4h9APwkAPTVf/MtqfwB9JQD01eK+/90AoJcEgB5S+wNAAOijyfhNANBrAkDPzGt/Fv8Aek8A6JF8dLir9gfAzDDoj8nfn0SOvQCg90wAeuJd7e84ACAEgP5Y1P4AYE4A6IF8dHCo9gfA+wSAPpgkb/sD4BcEgI5T+wPgQwSADlvc+Kf2B8CvqQF2Wb5W+wPgg0wAOmr+9D/xtj8APkwA6Cq1PwA+wRFAB80X/yKr/QHwUSYAXWTxD4DPEAA6Jj++80TtD4DPEQA6ZL74Fxb/APg8AaBLZot/nv4BuAEBoCMWl/647x+AmxEAumJ87b5/AG5MAOiARe0vDgMAbkgA6AK1PwAaEgAqlx8fPLP4B0BTAkDF5ot/OY4DABoSAGrmvn8AliQAVErtD4BVCAC1mozfBAAsSQCo0Lz2Z/EPgBUIAJXJR4e7an8ArGoY1GXy9yeRYy8AYAUmABVR+wOgLQJATdT+AGiJAFCJfHT7ntofAG0RAGox2fkmAKAlAkAF1P4AaJsAULjFjX9qfwC0SwAo3Wzxz9M/AC0TAArmvn8A1kUAKNn42uIfAGshABRqvvgXcS8AYA0EgFJZ/ANgjQSAAuXHB88s/gGwTgJAYeaLf5EeBACskQBQGrU/ADZAACiI2h8AmyIAlGRy/SoAYAMEgEIs7vuP/QCADRAASqH2B8AGCQAFUPsDYNMEgC2bL/7lOA4A2CABYNtmtT8A2DABYIvy0Z19tT8AtkEA2KZJqP0BsBUCwJYsan8W/wDYDgFgCxY3/qn9AbA9w2DzJtf3I8deAMCWmABsmNofACUQADZN7Q+AAggAG5SPbt9T+wOgBALAJk12vgkAKIAAsCFqfwCURADYALU/AEojAGzCbPHP0z8ABREA1mzx9G/xD4CyCADrNr62+AdAcQSANZov/kXcCwAojACwThb/ACiUALAm+fHBM4t/AJRKAFiDd/f9HwUAFEoAWIfFff+7AQCFEgBapvYHQA0EgLZNxm8CAAonALTIff8A1EIAaJPaHwCVEABaovYHQE0EgBa8q/0dBwBUQgBow6L2BwDVEABWlI/u7Kv9AVAbAWBVk3gVAFAZAWAFan8A1EoAWNLixj+1PwDqNAyWk6+fRI69AIAKmQAsYf70P/G2PwDqJQAsQ+0PgMoJAMvY2fkyAKBiAkBD+dHtezb/AaidANDcvQCAygkATe2k3wUAVE4AaCrHfgBA5QSABvLR/m4AQAcIAI38bwEAgE4QAACghwQAAOghAQAAekgAAIAeEgAAoIcEAADoIQEAAHpIAACAHhIAAKCHBAAA6CEBAAB6SAAAgB4SAACghwQAAOghAQAAekgAAIAeEgAAoIcEAADoIQEAAHpIAACAHhIAAKCHBAAA6KEUNJK/PsgBQHHSywvfaQ2YADSV8igAKEuKy6ARAaCpSfw5AChLzgJAQwJAUymfBwCF2fFw1pAA0NRg8nr661UAUI7BT6+DRgSAhtLJ5dV0CvB9AFCIfDb/bKYRAWAZkyRpApRicOt50JgAsIR0enEe2RQAYPtmT/9/GQWNCQDLGo6Pwi4AwBalkaf/5QkAS5qfN+X4KgDYjpyeevpfngCwgsVRQEifAJs2/exNp/9qH2sFrk1sQX50cDz9m3wWAKzf/Mv/4jhYiQDQEiEAYAN8+bdGAGjRNAQcxk76LnLeCwBalEbTz9aH86NXWmEHoEXzH8ydwd3pD+mLAKANV/Ndq8FvvvDl3y4TgDXJR7/fi+ufjmNn50sTAYDGZl/8L2L4Tyfp5Fzleg0EgA1YHA3E4fSH+cvp3/ju9Pf9AOC/za5Yn37hp8vp5+Pfpv997ml//f4L3vH+OAZ8xYAAAAAASUVORK5CYII\u003d"
  },
  "description": "Use this tag for sending data to the Server Container.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "event_type",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard",
        "subParams": [
          {
            "type": "SELECT",
            "name": "event_name_standard",
            "selectItems": [
              {
                "value": "page_view",
                "displayValue": "Page View"
              },
              {
                "value": "add_payment_info",
                "displayValue": "Add Payment Info"
              },
              {
                "value": "add_to_cart",
                "displayValue": "Add To Cart"
              },
              {
                "value": "add_to_wishlist",
                "displayValue": "Add To Wishlist"
              },
              {
                "value": "begin_checkout",
                "displayValue": "Begin Checkout"
              },
              {
                "value": "contact",
                "displayValue": "Contact"
              },
              {
                "value": "customize_product",
                "displayValue": "Customize Product"
              },
              {
                "value": "donate",
                "displayValue": "Donate"
              },
              {
                "value": "exception",
                "displayValue": "Exception"
              },
              {
                "value": "find_location",
                "displayValue": "Find Location"
              },
              {
                "value": "generate_lead",
                "displayValue": "Generate Lead"
              },
              {
                "value": "join_group",
                "displayValue": "Join Group"
              },
              {
                "value": "login",
                "displayValue": "Login"
              },
              {
                "value": "purchase",
                "displayValue": "Purchase"
              },
              {
                "value": "refund",
                "displayValue": "Refund"
              },
              {
                "value": "schedule",
                "displayValue": "Schedule"
              },
              {
                "value": "search",
                "displayValue": "Search"
              },
              {
                "value": "select_content",
                "displayValue": "Select Content"
              },
              {
                "value": "share",
                "displayValue": "Share"
              },
              {
                "value": "sign_up",
                "displayValue": "Sign Up"
              },
              {
                "value": "start_trial",
                "displayValue": "Start Trial"
              },
              {
                "value": "submit_application",
                "displayValue": "Submit Application"
              },
              {
                "value": "subscribe",
                "displayValue": "Subscribe"
              },
              {
                "value": "view_item",
                "displayValue": "View Item"
              },
              {
                "value": "view_item_list",
                "displayValue": "View Item List"
              },
              {
                "value": "view_search_results",
                "displayValue": "View Search Results"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "page_view",
            "alwaysInSummary": true
          }
        ]
      },
      {
        "value": "custom",
        "displayValue": "Custom",
        "subParams": [
          {
            "type": "TEXT",
            "name": "event_name_custom",
            "simpleValueType": true
          }
        ]
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "gtm_server_domain",
    "displayName": "GTM Server Side URL",
    "simpleValueType": true,
    "help": "Domain to where the tag will send requests.\u003cbr\u003eFor example: \u003ci\u003ehttps://gtm.example.com\u003c/i\u003e",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "add_data_layer",
    "checkboxText": "Send all from DataLayer",
    "simpleValueType": true,
    "help": "Adds all Data Layer values to the request."
  },
  {
    "type": "CHECKBOX",
    "name": "add_common",
    "checkboxText": "Send common data",
    "simpleValueType": true,
    "help": "Adds to request:\n\u003cul\u003e\n\u003cli\u003epage_location\u003c/li\u003e\n\u003cli\u003epage_path\u003c/li\u003e\n\u003cli\u003epage_hostname\u003c/li\u003e\n\u003cli\u003epage_referrer\u003c/li\u003e\n\u003cli\u003epage_title\u003c/li\u003e\n\u003cli\u003epage_encoding\u003c/li\u003e\n\u003cli\u003escreen_resolution\u003c/li\u003e\n\u003cli\u003eviewport_size\u003c/li\u003e\n\u003c/ul\u003e",
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "add_consent_state",
    "checkboxText": "Add consent state",
    "simpleValueType": true,
    "help": "Adds \u003cb\u003econsent_state\u003c/b\u003e object to request.\u003cbr/\u003e\nIncluding following properties:\u003cbr/\u003e \nad_storage\u003cbr/\u003e\nad_user_data\u003cbr/\u003e\nad_personalization\u003cbr/\u003e\nanalytics_storage\u003cbr/\u003e\nfunctionality_storage\u003cbr/\u003e\npersonalization_storage\u003cbr/\u003e\nsecurity_storage"
  },
  {
    "type": "CHECKBOX",
    "name": "add_common_cookie",
    "checkboxText": "Add Common Cookie",
    "simpleValueType": true,
    "help": "The tag will send common cookies in \u003cI\u003eeventData\u003c/i\u003e to avoid some e-commerce platform limitations. Now supported by the next Stape tags: \u003cbr /\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/facebook-tag\" target\u003d\"_blank\"\u003eFacebook Conversion API\u003c/a\u003e\u003cbr /\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/tiktok-tag\" target\u003d\"_blank\"\u003eTikTok Events API\u003c/a\u003e\u003cbr /\u003e\n\u003ca href\u003d\"https://github.com/stape-io/pinterest-tag\" target\u003d\"_blank\"\u003ePinterest Conversion API\u003c/a\u003e\u003cbr /\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/snapchat-tag\" target\u003d\"_blank\"\u003eSnapchat Conversion API\u003c/a\u003e\u003cbr /\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/taboola-tag\" target\u003d\"_blank\"\u003eTaboola\u003c/a\u003e\u003c/br\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/awin-tag\" target\u003d\"_blank\"\u003eAwin\u003c/a\u003e\u003c/br\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/rakuten-tag\" target\u003d\"_blank\"\u003eRakuten\u003c/a\u003e\u003c/br\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/klaviyo-tag\" target\u003d\"_blank\"\u003eKlaviyo\u003c/a\u003e\u003c/br\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/outbrain-tag\" target\u003d\"_blank\"\u003eOutbrain\u003c/a\u003e\u003c/br\u003e\n\u003ca href\u003d\"https://tagmanager.google.com/gallery/#/owners/stape-io/templates/webgains-tag\" target\u003d\"_blank\"\u003eWebgains\u003c/a\u003e\u003c/br\u003e"
  },
  {
    "type": "GROUP",
    "name": "custom",
    "displayName": "Event Data",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "custom_data",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          },
          {
            "defaultValue": "none",
            "displayName": "Transformation",
            "name": "transformation",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "none",
                "displayValue": "None"
              },
              {
                "value": "trim",
                "displayValue": "Trim"
              },
              {
                "value": "to_lower_case",
                "displayValue": "To lower case"
              },
              {
                "value": "md5",
                "displayValue": "MD5 hash"
              },
              {
                "value": "base64",
                "displayValue": "Base64"
              },
              {
                "value": "sha256base64",
                "displayValue": "SHA-256 digest (Base64 encoded)"
              },
              {
                "value": "sha256hex",
                "displayValue": "SHA-256 digest (HEX encoded)"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "none",
            "displayName": "Store",
            "name": "store",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "none",
                "displayValue": "None"
              },
              {
                "value": "all",
                "displayValue": "Everywhere"
              },
              {
                "value": "localStorage",
                "displayValue": "Local Storage"
              },
              {
                "value": "cookies",
                "displayValue": "Cookies"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "user",
    "displayName": "User Data",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "user_data",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "email_address",
            "displayName": "Name",
            "name": "name",
            "type": "SELECT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "isUnique": true,
            "selectItems": [
              {
                "value": "email_address",
                "displayValue": "Email Address"
              },
              {
                "value": "phone_number",
                "displayValue": "Phone Number"
              },
              {
                "value": "first_name",
                "displayValue": "First Name"
              },
              {
                "value": "last_name",
                "displayValue": "Last Name"
              },
              {
                "value": "gender",
                "displayValue": "Gender"
              },
              {
                "value": "db",
                "displayValue": "Date of Birth"
              },
              {
                "value": "street",
                "displayValue": "Street"
              },
              {
                "value": "city",
                "displayValue": "City"
              },
              {
                "value": "region",
                "displayValue": "Region"
              },
              {
                "value": "postal_code",
                "displayValue": "Postal Code"
              },
              {
                "value": "country",
                "displayValue": "Country"
              },
              {
                "value": "user_id",
                "displayValue": "User ID"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          },
          {
            "defaultValue": "none",
            "displayName": "Transformation",
            "name": "transformation",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "none",
                "displayValue": "None"
              },
              {
                "value": "trim",
                "displayValue": "Trim"
              },
              {
                "value": "to_lower_case",
                "displayValue": "To lower case"
              },
              {
                "value": "md5",
                "displayValue": "MD5 hash"
              },
              {
                "value": "base64",
                "displayValue": "Base64"
              },
              {
                "value": "sha256base64",
                "displayValue": "SHA-256 digest (Base64 encoded)"
              },
              {
                "value": "sha256hex",
                "displayValue": "SHA-256 digest (HEX encoded)"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "none",
            "displayName": "Store",
            "name": "store",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "none",
                "displayValue": "None"
              },
              {
                "value": "all",
                "displayValue": "Everywhere"
              },
              {
                "value": "localStorage",
                "displayValue": "Local Storage"
              },
              {
                "value": "cookies",
                "displayValue": "Cookies"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "settings",
    "displayName": "Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "request_type",
        "displayName": "Request type",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "auto",
            "displayValue": "Auto"
          },
          {
            "value": "post",
            "displayValue": "POST"
          },
          {
            "value": "get",
            "displayValue": "GET"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "auto",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "We highly recommend using \u003cb\u003eAuto\u003c/b\u003e. Change this only if you know what you are doing."
      },
      {
        "type": "TEXT",
        "name": "request_path",
        "displayName": "Path",
        "simpleValueType": true,
        "defaultValue": "/data",
        "help": "The path used for sending requests to the GTM Server Side container. If you use the Data client on GTM Server Side, the Path should be \u003cb\u003e/data\u003c/b\u003e.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "^/.*"
            ],
            "errorMessage": "The path must start with /."
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "protocol_version",
        "displayName": "Protocol version",
        "simpleValueType": true,
        "defaultValue": 2,
        "help": "Protocol version that used for sending a request to Data client on GTM Server Side.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "data_tag_load_script_url",
        "displayName": "Data Tag Script URL",
        "simpleValueType": true,
        "help": "URL where to load Data tag script from, by default it will be loaded from \u003cI\u003ehttps://stapecdn.com/dtag/${data-script-version}.js\u003c/i\u003e. This can be parameterized with \u003ci\u003e${data-script-version}\u003c/i\u003e in order to load the correct version for this tag.",
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^(https://).*(\\.js)$"
            ]
          }
        ],
        "alwaysInSummary": false,
        "defaultValue": "https://stapecdn.com/dtag/v8.js"
      },
      {
        "type": "CHECKBOX",
        "name": "addGaParameters",
        "checkboxText": "Add GA4 specific parameters",
        "simpleValueType": true,
        "help": "Adds specific parameters for the server GA4 tag.",
        "defaultValue": false,
        "enablingConditions": [
          {
            "paramName": "request_type",
            "paramValue": "post",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "gaId",
        "displayName": "Measurement ID",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "addGaParameters",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueHint": "G-ABCD123456",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Enter the Measurement ID of your GA4 property."
      },
      {
        "type": "CHECKBOX",
        "name": "dataLayerEventPush",
        "checkboxText": "Push event to DataLayer after tag receives a response",
        "simpleValueType": true,
        "help": "Helpful in obtaining data from the server.",
        "defaultValue": false
      },
      {
        "type": "TEXT",
        "name": "dataLayerEventName",
        "displayName": "DataLayer Event Name",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "dataLayerEventPush",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "valueHint": "page_view_response"
      },
      {
        "type": "TEXT",
        "name": "dataLayerVariableName",
        "displayName": "DataLayer Object Name",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "dataLayerEventPush",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "dataLayer",
        "help": "Use \u003ci\u003edataLayer\u003c/i\u003e by default. Modify only if you renamed dataLayer object name."
      },
      {
        "type": "CHECKBOX",
        "name": "richsstsse",
        "checkboxText": "Support rich command protocol",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "request_type",
            "paramValue": "get",
            "type": "NOT_EQUALS"
          }
        ],
        "help": "Useful if you have server-side tags, that (partially) depend on the \u003cI\u003esendPixelFromBrowser()\u003c/i\u003e API for 3rd party cookies (e.g. Google Ads Conversion, Google Ads Remarketing).",
        "defaultValue": false
      },
      {
        "type": "CHECKBOX",
        "name": "waitForCookies",
        "checkboxText": "Wait for cookies before event is pushed",
        "simpleValueType": true,
        "defaultValue": false,
        "enablingConditions": [
          {
            "paramName": "richsstsse",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "help": "Wait for all cookies to be set before event is pushed to DataLayer. Helpful if a server-side tag sets cookies that a web tag relies on."
      },
      {
        "type": "CHECKBOX",
        "name": "useFetchInsteadOfXHR",
        "checkboxText": "Use fetch instead of XMLHttpRequest (for POST requests only)",
        "simpleValueType": true,
        "help": "Using \u003ci\u003efetch\u003c/i\u003e with \u003ci\u003ekeepalive\u003c/i\u003e option which allow the request to outlive the page. \u003ca href\u003d\"https://developer.mozilla.org/en-US/docs/Web/API/fetch#keepalive\"\u003eRead more\u003c/a\u003e.",
        "defaultValue": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const copyFromDataLayer = require('copyFromDataLayer');
const JSON = require('JSON');
const getUrl = require('getUrl');
const getReferrerUrl = require('getReferrerUrl');
const readTitle = require('readTitle');
const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const makeNumber = require('makeNumber');
const readCharacterSet = require('readCharacterSet');
const localStorage = require('localStorage');
const sendPixel = require('sendPixel');
const encodeUriComponent = require('encodeUriComponent');
const toBase64 = require('toBase64');
const makeString = require('makeString');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const getContainerVersion = require('getContainerVersion');
const isConsentGranted = require('isConsentGranted');

let pageLocation = getUrl();

if (
  pageLocation &&
  pageLocation.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0
) {
  data.gtmOnSuccess();

  return;
}

const userAndCustomData = getUserAndCustomDataArray();
let requestType = determinateRequestType();

const normalizedServerUrl = normalizeServerUrl();

if (requestType === 'post') {
  const dataScriptVersion = 'v8';
  const dataTagScriptUrl =
    typeof data.data_tag_load_script_url !== 'undefined'
      ? data.data_tag_load_script_url.replace(
          '${data-script-version}',
          dataScriptVersion
        )
      : 'https://stapecdn.com/dtag/' + dataScriptVersion + '.js';
  injectScript(
    dataTagScriptUrl,
    sendPostRequest,
    data.gtmOnFailure,
    dataTagScriptUrl
  );
} else {
  sendGetRequest();
}

function sendPostRequest() {
  let eventData = {};

  eventData = addCommonDataForPostRequest(data, eventData);
  eventData = addRequiredDataForPostRequest(data, eventData);
  eventData = addGaRequiredData(data, eventData);

  callInWindow(
    'dataTagSendData',
    eventData,
    normalizedServerUrl.gtmServerDomain,
    normalizedServerUrl.requestPath +
      '?v=' +
      eventData.v +
      '&event_name=' +
      encodeUriComponent(eventData.event_name) +
      (data.richsstsse ? '&richsstsse' : ''),
    data.dataLayerEventName,
    data.dataLayerVariableName,
    data.waitForCookies,
    data.useFetchInsteadOfXHR
  );

  data.gtmOnSuccess();
}

function sendGetRequest() {
  sendPixel(
    addDataForGetRequest(data, buildEndpoint()),
    data.gtmOnSuccess,
    data.gtmOnFailure
  );
}

function normalizeServerUrl() {
  let gtmServerDomain = data.gtm_server_domain;
  let requestPath = data.request_path;
  
  // Add 'https://' if gtmServerDomain doesn't start with it
  if (gtmServerDomain.indexOf('http://') !== 0 && gtmServerDomain.indexOf('https://') !== 0) {
    gtmServerDomain = 'https://' + gtmServerDomain;
  }
  
  // Removes trailing slash from gtmServerDomain if it ends with it
  if (gtmServerDomain.charAt(gtmServerDomain.length - 1) === '/') {
    gtmServerDomain = gtmServerDomain.slice(0, -1);
  }
  
  // Adds slash to first position of requestPath if doesn't start with it
  if (requestPath.charAt(0) !== '/') {
    requestPath = '/' + requestPath;
  }
  
  return {
    gtmServerDomain: gtmServerDomain,
    requestPath: requestPath
  };
}


function buildEndpoint() {
  return normalizedServerUrl.gtmServerDomain + normalizedServerUrl.requestPath;
}

function addRequiredDataForPostRequest(data, eventData) {
  eventData.event_name = getEventName(data);
  eventData.v = makeNumber(data.protocol_version);

  let customData = getCustomData(data, true);

  for (let key in customData) {
    eventData[customData[key].name] = customData[key].value;
  }

  return eventData;
}

function addGaRequiredData(data, eventData) {
  if (data.addGaParameters && data.gaId) {
    eventData['x-ga-measurement_id'] = data.gaId;
    eventData['x-ga-page_id'] = copyFromDataLayer('gtm.start');
    eventData['x-ga-mp2-richsstsse'] = '';
    eventData['x-ga-mp2-seg'] = 1;
    eventData['x-ga-request_count'] = 1;
    eventData['x-ga-protocol_version'] = 2;
    eventData.v = 2;
  }

  return eventData;
}

function addDataForGetRequest(data, url) {
  let eventData = {};
  url +=
    '?v=' +
    data.protocol_version +
    '&event_name=' +
    encodeUriComponent(getEventName(data));

  if (data.add_common) {
    eventData = addCommonData(data, eventData);
  }

  if (data.add_consent_state) {
    eventData = addConsentStateData(eventData);
  }

  if (data.add_common_cookie) {
    eventData = addCommonCookie(eventData);
  }

  let customData = getCustomData(data, false);

  if (customData.length) {
    for (let customDataKey in customData) {
      eventData[customData[customDataKey].name] =
        customData[customDataKey].value;
    }
  }

  if (data.request_type === 'auto') {
    return (
      url + '&dtdc=' + encodeUriComponent(toBase64(JSON.stringify(eventData)))
    );
  }

  for (let eventDataKey in eventData) {
    url +=
      '&' +
      eventDataKey +
      '=' +
      (eventData[eventDataKey]
        ? encodeUriComponent(eventData[eventDataKey])
        : '');
  }

  return url;
}

function addCommonDataForPostRequest(data, eventData) {
  if (data.add_common || data.add_data_layer) {
    const dataTagData = callInWindow(
      'dataTagGetData',
      getContainerVersion()['containerId']
    );

    if (data.add_data_layer && dataTagData.dataModel) {
      for (let dataKey in dataTagData.dataModel) {
        eventData[dataKey] = dataTagData.dataModel[dataKey];
      }
    }

    if (data.add_common) {
      eventData = addCommonData(data, eventData);
      eventData.screen_resolution =
        dataTagData.screen.width + 'x' + dataTagData.screen.height;
      eventData.viewport_size =
        dataTagData.innerWidth + 'x' + dataTagData.innerHeight;
    }
  }
  if (data.add_consent_state) {
    eventData = addConsentStateData(eventData);
  }

  if (data.add_common_cookie) {
    eventData = addCommonCookie(eventData);
  }

  return eventData;
}

function addCommonData(data, eventData) {
  eventData.page_location = getUrl();
  eventData.page_hostname = getUrl('host');
  eventData.page_referrer = getReferrerUrl();
  eventData.page_title = readTitle();
  eventData.page_encoding = readCharacterSet();

  return eventData;
}

function addConsentStateData(eventData) {
  eventData.consent_state = {
    ad_storage: isConsentGranted('ad_storage'),
    ad_user_data: isConsentGranted('ad_user_data'),
    ad_personalization: isConsentGranted('ad_personalization'),
    analytics_storage: isConsentGranted('analytics_storage'),
    functionality_storage: isConsentGranted('functionality_storage'),
    personalization_storage: isConsentGranted('personalization_storage'),
    security_storage: isConsentGranted('security_storage'),
  };
  return eventData;
}

function getEventName(data) {
  const eventName = 'page_view';

  if (data.event_type === 'standard') {
    return data.event_name_standard ? data.event_name_standard : eventName;
  }

  if (data.event_type === 'custom') {
    return data.event_name_custom ? data.event_name_custom : eventName;
  }

  return eventName;
}

function getCustomData(data, dtagLoaded) {
  let dataToStore = [];
  let customData = userAndCustomData;

  for (let dataKey in customData) {
    let dataValue = customData[dataKey].value;
    let dataTransformation = customData[dataKey].transformation;

    if (dataValue) {
      if (dataTransformation === 'trim') {
        dataValue = makeString(dataValue);
        dataValue = dataValue.trim();
      }

      if (dataTransformation === 'to_lower_case') {
        dataValue = makeString(dataValue);
        dataValue = dataValue.trim().toLowerCase();
      }

      if (dataTransformation === 'base64') {
        dataValue = makeString(dataValue);
        dataValue = toBase64(dataValue);
      }

      if (dtagLoaded && dataTransformation === 'md5') {
        dataValue = makeString(dataValue);
        dataValue = callInWindow('dataTagMD5', dataValue.trim().toLowerCase());
      }

      if (dtagLoaded && dataTransformation === 'sha256base64') {
        dataValue = makeString(dataValue);
        dataValue = callInWindow(
          'dataTag256',
          dataValue.trim().toLowerCase(),
          'B64'
        );
      }

      if (dtagLoaded && dataTransformation === 'sha256hex') {
        dataValue = makeString(dataValue);
        dataValue = callInWindow(
          'dataTag256',
          dataValue.trim().toLowerCase(),
          'HEX'
        );
      }

      if (customData[dataKey].store && customData[dataKey].store !== 'none') {
        dataToStore.push({
          store: customData[dataKey].store,
          name: customData[dataKey].name,
          value: dataValue,
        });
      }

      customData[dataKey].value = dataValue;
    }
  }

  if (dataToStore.length !== 0) {
    storeData(dataToStore);
  }

  return customData;
}

function storeData(dataToStore) {
  let dataToStoreCookieResult = {};
  let dataToStoreLocalStorageResult = {};
  let dataToStoreCookie = getCookieValues('stape')[0];

  if (dataToStoreCookie) {
    dataToStoreCookie = JSON.parse(dataToStoreCookie);

    if (dataToStoreCookie) {
      for (let attrName in dataToStoreCookie) {
        if (dataToStoreCookie[attrName])
          dataToStoreCookieResult[attrName] = dataToStoreCookie[attrName];
      }
    }
  }

  if (localStorage) {
    let dataToStoreLocalStorage = localStorage.getItem('stape');

    if (dataToStoreLocalStorage) {
      dataToStoreLocalStorage = JSON.parse(dataToStoreLocalStorage);

      if (dataToStoreLocalStorage) {
        for (let attrName in dataToStoreLocalStorage) {
          if (dataToStoreLocalStorage[attrName])
            dataToStoreLocalStorageResult[attrName] =
              dataToStoreLocalStorage[attrName];
        }
      }
    }
  }

  for (let attrName in dataToStore) {
    if (dataToStore[attrName].value) {
      if (
        dataToStore[attrName].store === 'all' ||
        dataToStore[attrName].store === 'localStorage'
      ) {
        dataToStoreLocalStorageResult[dataToStore[attrName].name] =
          dataToStore[attrName].value;
      }

      if (
        dataToStore[attrName].store === 'all' ||
        dataToStore[attrName].store === 'cookies'
      ) {
        dataToStoreCookieResult[dataToStore[attrName].name] =
          dataToStore[attrName].value;
      }
    }
  }

  if (localStorage && getObjectLength(dataToStoreLocalStorageResult) !== 0) {
    localStorage.setItem(
      'stape',
      JSON.stringify(dataToStoreLocalStorageResult)
    );
  }

  if (getObjectLength(dataToStoreCookieResult) !== 0) {
    setCookie('stape', JSON.stringify(dataToStoreCookieResult), {
      secure: true,
      domain: 'auto',
      path: '/',
    });
  }
}

function getObjectLength(object) {
  let length = 0;

  for (let key in object) {
    if (object.hasOwnProperty(key)) {
      ++length;
    }
  }
  return length;
}

function determinateRequestType() {
  if (data.request_type !== 'auto') {
    return data.request_type;
  }

  if (data.add_data_layer) {
    return 'post';
  }

  if (data.dataLayerEventPush) {
    return 'post';
  }

  if (data.richsstsse) {
    return 'post';
  }

  const isHashingEnabled = userAndCustomData.some(
    (item) =>
      item.transformation === 'md5' ||
      item.transformation === 'sha256base64' ||
      item.transformation === 'sha256hex'
  );

  if (isHashingEnabled) return 'post';

  const userAndCustomDataLength = makeNumber(
    JSON.stringify(userAndCustomData).length
  );
  return userAndCustomDataLength > 1500 ? 'post' : 'get';
}

function getUserAndCustomDataArray() {
  let userAndCustomDataArray = [];

  if (data.custom_data && data.custom_data.length) {
    userAndCustomDataArray = data.custom_data;
  }

  if (data.user_data && data.user_data.length) {
    for (let userDataKey in data.user_data) {
      userAndCustomDataArray.push(data.user_data[userDataKey]);
    }
  }
  return userAndCustomDataArray;
}

function addCommonCookie(eventData) {
  const cookieNames = [
    // FB cookies
    '_fbc',
    '_fbp',
    '_gtmeec',
    // TikTok cookies
    'ttclid',
    '_ttp',
    // Pinterest cookies
    '_epik',
    // Snapchat cookies
    '_scid',
    '_scclid',
    // Taboola cookies
    'taboola_cid',
    // Awin cookies
    'awin_awc',
    'awin_sn_awc',
    'awin_source',
    // Rakuten cookies
    'rakuten_site_id',
    'rakuten_time_entered',
    'rakuten_ran_mid',
    'rakuten_ran_eaid',
    'rakuten_ran_site_id',
    // Klaviyo cookies
    'stape_klaviyo_email',
    'stape_klaviyo_kx',
    'stape_klaviyo_viewed_items',
    // Outbrain cookies
    'outbrain_cid',
    // Webgains cookies
    'wg_cid'
  ];
  let commonCookie = null;

  for (var i = 0; i < cookieNames.length; i++) {
    const name = cookieNames[i];
    var cookie = getCookieValues(name)[0];
    if (cookie) {
      commonCookie = commonCookie || {};
      commonCookie[name] = cookie;
    }
  }
  if (commonCookie) {
    eventData.common_cookie = commonCookie;
  }
  return eventData;
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataTagSendData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataTagGetData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataTagData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataTagMD5"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataTag256"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "gtm.uniqueEventId"
              },
              {
                "type": 1,
                "string": "gtm.start"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_title",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://stapecdn.com/dtag/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stape"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_character_set",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "stape"
              },
              {
                "type": 1,
                "string": "_fbc"
              },
              {
                "type": 1,
                "string": "_fbp"
              },
              {
                "type": 1,
                "string": "_gtmeec"
              },
              {
                "type": 1,
                "string": "ttclid"
              },
              {
                "type": 1,
                "string": "_ttp"
              },
              {
                "type": 1,
                "string": "_epik"
              },
              {
                "type": 1,
                "string": "_scid"
              },
              {
                "type": 1,
                "string": "_scclid"
              },
              {
                "type": 1,
                "string": "taboola_cid"
              },
              {
                "type": 1,
                "string": "awin_awc"
              },
              {
                "type": 1,
                "string": "awin_sn_awc"
              },
              {
                "type": 1,
                "string": "awin_source"
              },
              {
                "type": 1,
                "string": "rakuten_site_id"
              },
              {
                "type": 1,
                "string": "rakuten_time_entered"
              },
              {
                "type": 1,
                "string": "rakuten_ran_mid"
              },
              {
                "type": 1,
                "string": "rakuten_ran_eaid"
              },
              {
                "type": 1,
                "string": "rakuten_ran_site_id"
              },
              {
                "type": 1,
                "string": "stape_klaviyo_email"
              },
              {
                "type": 1,
                "string": "stape_klaviyo_kx"
              },
              {
                "type": 1,
                "string": "stape_klaviyo_viewed_items"
              },
              {
                "type": 1,
                "string": "outbrain_cid"
              },
              {
                "type": 1,
                "string": "wg_cid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stape"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: GTM Server Side URL and Request Path for GET requests are normalized
  code: "mockData.request_type = 'get';\nmockData.event_type = 'standard';\nmockData.event_name_standard\
    \ = 'cc';\n\n[\n  { gtm_server_domain: 'example.com', request_path: '/foo', expectedServerUrl:\
    \ 'https://example.com/foo' },\n  { gtm_server_domain: 'example.com/', request_path:\
    \ '/foo', expectedServerUrl: 'https://example.com/foo' },\n  { gtm_server_domain:\
    \ 'https://example.com', request_path: '/foo', expectedServerUrl: 'https://example.com/foo'\
    \ },\n  { gtm_server_domain: 'https://example.com/', request_path: '/foo', expectedServerUrl:\
    \ 'https://example.com/foo' },\n  { gtm_server_domain: 'example.com', request_path:\
    \ 'foo/', expectedServerUrl: 'https://example.com/foo' },\n  { gtm_server_domain:\
    \ 'example.com/', request_path: 'foo/', expectedServerUrl: 'https://example.com/foo'\
    \ },\n  { gtm_server_domain: 'https://example.com', request_path: 'foo/', expectedServerUrl:\
    \ 'https://example.com/foo' },\n  { gtm_server_domain: 'https://example.com/',\
    \ request_path: 'foo/', expectedServerUrl: 'https://example.com/foo' },\n  { gtm_server_domain:\
    \ 'http://example.com', request_path: '/foo', expectedServerUrl: 'http://example.com/foo'\
    \ },\n  { gtm_server_domain: 'http://example.com/', request_path: '/foo', expectedServerUrl:\
    \ 'http://example.com/foo' },\n  { gtm_server_domain: 'http://example.com', request_path:\
    \ 'foo/', expectedServerUrl: 'http://example.com/foo' },\n  { gtm_server_domain:\
    \ 'http://example.com/', request_path: 'foo/', expectedServerUrl: 'http://example.com/foo'\
    \ },\n].forEach((testCase, testNumber) => {\n  mockData.gtm_server_domain = testCase.gtm_server_domain;\n\
    \  mockData.request_path = testCase.request_path;\n  \n  mock('sendPixel', function(url,\
    \ onSuccess, onFailure) {\n    // logToConsole('#' + testNumber + ' - sendPixel\
    \ called with URL:', url);\n    assertThat(url).contains(testCase.expectedServerUrl);\n\
    \  });\n\n  runCode(mockData);\n});"
- name: GTM Server Side URL and Request Path for POST requests are normalized
  code: "mockData.request_type = 'post';\nmockData.event_type = 'standard';\nmockData.event_name_standard\
    \ = 'cc';\n\nmock('injectScript', function(url, onSuccess, onFailure, cacheToken)\
    \ {\n  // logToConsole('injectScript called with URL:', url);\n  onSuccess();\n\
    });\n\nconst expectedRequestPathParams = '?v=' + mockData.protocol_version + '&event_name='\
    \ + mockData.event_name_standard;\n\n[\n  { gtm_server_domain: 'example.com',\
    \ request_path: '/foo', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo' + expectedRequestPathParams },\n  { gtm_server_domain: 'example.com/',\
    \ request_path: '/foo', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo' + expectedRequestPathParams },\n  { gtm_server_domain: 'https://example.com',\
    \ request_path: '/foo', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo' + expectedRequestPathParams },\n  { gtm_server_domain: 'https://example.com/',\
    \ request_path: '/foo', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo' + expectedRequestPathParams },\n  { gtm_server_domain: 'example.com',\
    \ request_path: 'foo/', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo/' + expectedRequestPathParams },\n  { gtm_server_domain: 'example.com/',\
    \ request_path: 'foo/', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo/' + expectedRequestPathParams },\n  { gtm_server_domain: 'https://example.com',\
    \ request_path: 'foo/', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo/' + expectedRequestPathParams },\n  { gtm_server_domain: 'https://example.com/',\
    \ request_path: 'foo/', expectedGtmServerDomain: 'https://example.com', expectedRequestPath:\
    \ '/foo/' + expectedRequestPathParams },\n  { gtm_server_domain: 'http://example.com',\
    \ request_path: '/foo', expectedGtmServerDomain: 'http://example.com', expectedRequestPath:\
    \ '/foo' + expectedRequestPathParams },\n  { gtm_server_domain: 'http://example.com/',\
    \ request_path: '/foo', expectedGtmServerDomain: 'http://example.com', expectedRequestPath:\
    \ '/foo' + expectedRequestPathParams },\n  { gtm_server_domain: 'http://example.com',\
    \ request_path: 'foo/', expectedGtmServerDomain: 'http://example.com', expectedRequestPath:\
    \ '/foo/' + expectedRequestPathParams },\n  { gtm_server_domain: 'http://example.com/',\
    \ request_path: 'foo/', expectedGtmServerDomain: 'http://example.com', expectedRequestPath:\
    \ '/foo/' + expectedRequestPathParams },\n].forEach((testCase, testNumber) =>\
    \ {\n  mockData.gtm_server_domain = testCase.gtm_server_domain;\n  mockData.request_path\
    \ = testCase.request_path;\n  \n  mock('callInWindow', function(functionName,\
    \ eventData, gtmServerDomain, requestPath, dataLayerEventName, dataLayerVariableName,\
    \ waitForCookies, useFetchInsteadOfXHR) {\n    /*\n    logToConsole('#' + testNumber\
    \ + ' - callInWindow called with:', {\n      functionName: functionName,\n   \
    \   gtmServerDomain: gtmServerDomain,\n      requestPath: requestPath,\n    });\n\
    \    */\n    \n    assertThat(gtmServerDomain).isEqualTo(testCase.expectedGtmServerDomain);\n\
    \    assertThat(requestPath).isEqualTo(testCase.expectedRequestPath);\n  });\n\
    \n  runCode(mockData);\n});"
setup: |-
  const mockData = {
    protocol_version: '2'
  };


___NOTES___

Created on 21/03/2021, 11:26:46


